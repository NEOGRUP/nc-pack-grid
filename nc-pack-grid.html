<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../nc-items-grid/nc-items-grid.html">
<link rel="import" href="../nc-products-grid/nc-products-grid.html">

<dom-module id="nc-pack-grid">
  <template>
    <style>
      .optionsContainer{
        /* background-color: darkseagreen; */
        height: 80px;
      }

      .elementsContainer{
        /* background-color: darksalmon; */
        height: calc(100% - 80px - 60px); /* 80px optionsContainer + 60px button*/
      }

       paper-button{
        margin: 10px 5px;
        background-color: var(--app-secondary-color);
        color: white;
      }
    </style>

    <div class="optionsContainer">
      <nc-items-grid
          items-grid-data="{{packOptions}}"
          loading="{{itemsGridLoading}}"
          language="{{language}}"
          is-paginated
          auto-flow
          dimension="70"
          on-item-selected="_packOptionSelected">
      </nc-items-grid>
    </div>
    <div class="elementsContainer">
      <nc-products-grid
          products-grid-data="{{packElementsGridData}}"
          loading="{{itemsGridLoading}}"
          language="{{language}}"
          on-product-selected="_packElementSelected">
      </nc-products-grid>
    </div>
    <paper-button raised on-tap="_closePackSelection">Volver</paper-button>

  </template>

  <script>
    class NcPacksGrid extends Polymer.Element {
      static get is() { return 'nc-pack-grid'; }
      static get properties() {
        return {
          packOptions: {
            type: Array,
            value: []
          },
          packOptionCodeSelected: String,
          packElementsGridData: {
            type: Array,
          },
          language: String,
          breadcrumb: {
            type: Boolean,
            value: false
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
      }

      setOptions(packOptions){
        this.set('packOptions',[]);
        let packOptionsFiltered = packOptions.filter(this.checkOptionVisible);
        this.set('packOptions',packOptionsFiltered);
        Polymer.dom.flush();
        this.selectDefaultOption();
      }

      checkOptionVisible(packOption){
        return (packOption.hasOwnProperty('visible') ? false: true);
      }

      selectDefaultOption(){
        let i;
        let optionCompleted;
        optionCompleted = false;

        for (i in this.packOptions){
          if ((this.packOptions[i].minQty === 1) && (this.packOptions[i].maxQty !== this.packOptions[i].used) && (this.packOptions[i].visible != false)){
            optionCompleted = true;
            this.packOptionCodeSelected = this.packOptions[i].code;
            this.packElementsGridData = this.packOptions[i].content;
            break;
          }
        }

        if (!optionCompleted){
          for (i in this.packOptions){
            if ((this.packOptions[i].minQty === 1) && (this.packOptions[i].visible != false)){
              optionCompleted = true;
              this.packOptionCodeSelected = this.packOptions[i].code;
              this.packElementsGridData = this.packOptions[i].content;
              break;
            }
          }
        }

        if (!optionCompleted){
          optionCompleted = true;
            this.packOptionCodeSelected = this.packOptions[0].code;
            this.packElementsGridData = this.packOptions[0].content;
        }

      }

      _packOptionSelected(option){
        this.packOptionCodeSelected = option.detail.code;
        this.packElementsGridData = option.detail.content;
      }

      _packElementSelected(item){
        this.dispatchEvent(new CustomEvent('pack-line-selected', {detail: {product: item.detail, packOptionCodeSelected: this.packOptionCodeSelected}, bubbles: true, composed: true }));
      }

      _closePackSelection(){
        this.dispatchEvent(new CustomEvent('close-pack-selection', {bubbles: true, composed: true }));
      }
    }

    window.customElements.define(NcPacksGrid.is, NcPacksGrid);
  </script>
</dom-module>
